<!doctype html><style>@font-face{font-family:emoji;src:url(https://cdn.jsdelivr.net/npm/twemoji-colr-font@14.0.2/twemoji.woff2)}#c{position:absolute;top:0;left:0;right:0;bottom:0;width:100%;height:100%;touch-action:none}#playButton{color:#fff;background:#000;border-radius:12px;padding:15px 25px;font-size:32px;border:2px solid transparent}#playButton:hover{background-color:#666;border:2px solid #000}#playButton:active{background-color:#0065bf}</style><title>JS13k Jam 2023</title><script type=module src=https://cdnjs.cloudflare.com/ajax/libs/babylonjs/6.16.2/babylon.js></script><script type=module>const t="#dc3220",e="#12b212",s="#0a650a",n="#fefe62",i="#ffc20a",o="#ffffff",h="#666666",r="#000000",a="#0065BF",c=window.location.search.includes("debug"),B=t=>t[Math.floor(Math.random()*t.length)],l=(t=512)=>{const e=document.createElement("canvas");e.width=t,e.height=t;const s=e.getContext("2d");return[e,s]},{StandardMaterial:w,Texture:d}=BABYLON;let u=0;const N={},O=(t=!0,e,s)=>{const n="castle"+e;if(N[n])return N[n];const[i,a]=l(512);a.fillStyle="#c5a296",a.fillRect(0,0,i.width,i.height);const c=16/e,w=32/e;a.save(),a.strokeStyle=r,a.lineWidth=4;const d=["#dd7d7d","#cb6b6b","#b65454","#9e3333","#842020"];for(let t=0;i.height>t*c;t++)for(let e=0;i.width>e*w;e++){a.fillStyle=B(d);const s=t%2?0:-.5*w;a.fillRect(e*w+s,t*c,w-1,c-1),0===e&&a.fillRect(e*w+i.width+s,t*c,w-1,c-1)}a.restore(),t&&(a.fillStyle=h,a.fillRect(192,128,128,256),a.strokeStyle=o,a.lineWidth=16,a.strokeRect(192,128,128,256),a.beginPath(),a.moveTo(256,128),a.lineTo(256,384),a.moveTo(192,224),a.lineTo(320,224),a.stroke());const u=Y(i,s);return N[n]=u,u},A=(t,e)=>{const s="color"+t;if(N[s])return N[s];const n=new w("billboardMaterial"+ ++u,e);return n.diffuseColor=BABYLON.Color3.FromHexString(t),N[s]=n,n},Y=(t,e)=>{const s=new w("material"+ ++u,e),n=d.LoadFromDataString("texture"+ ++u,t.toDataURL(),e);return n.hasAlpha=!0,s.diffuseTexture=n,s},L=t=>{const e="gravel";if(N[e])return N[e];const[s,n]=l(512);n.fillStyle="#c5a296",n.fillRect(0,0,s.width,s.height),n.save(),n.strokeStyle=r,n.lineWidth=4,n.fillStyle="#30312D",n.fillRect(0,0,s.width,s.height),["#4A4B46","#484848","#4E523F","#63645F","#64655f"].forEach(t=>{n.fillStyle=t;for(let t=0;128>t;t++){const t=Math.random()*(s.width-16)+8,e=Math.random()*(s.height-16)+8;n.beginPath(),n.moveTo(t,e),n.arc(t,e,8,0,2*Math.PI),n.fill()}});const i=Y(s,t);return N[e]=i,i},p=(t,e)=>{const s="dial-"+t;if(N[s])return N[s];const[n,o]=l(512);o.fillStyle=i,o.fillRect(0,0,n.width,n.height),o.fillStyle=r;const a=n.width/t.length;o.font=a+"px Helvetica",o.scale(1,n.height/a),o.textBaseline="middle",o.textAlign="center",t.forEach((t,e)=>{o.strokeStyle=h,o.strokeRect(e*a,0,(e+1)*a,a),o.fillText(""+t,e*a+.5*a,.5*a)});const c=Y(n,e);return N[s]=c,c},f=(t,e)=>{const s="text-"+t.join("");if(N[s])return N[s];const[n,o]=l(512);if(o.fillStyle=i,o.fillRect(0,0,n.width,n.height),o.fillStyle=r,o.font="64px Helvetica",o.scale(1,3),o.textBaseline="top",o.textAlign="left",t.length>0){const e=o.measureText(t[0]);o.font=28672/e.width+"px Helvetica"}t.forEach((t,e)=>{o.fillText(""+t,32,32+72*e)});const h=Y(n,e);return N[s]=h,h},m=t=>{const e="symbol";if(N[e])return N[e];const[s,n]=l(512);n.fillStyle=a,n.fillRect(128,0,256,512),n.fillStyle=i,n.fillRect(192,64,128,128),n.beginPath(),n.moveTo(256,256),n.arc(256,256,64,0,2*Math.PI),n.fill(),n.beginPath(),n.moveTo(256,320),n.lineTo(320,431),n.lineTo(192,431),n.fill();const o=Y(s,t);return N[e]=o,o},M=t=>{const e=BABYLON.Color3.FromHexString(t.color1||"#ff0000"),s=BABYLON.Color3.FromHexString(t.color2||"#0000ff"),n=t.scale||1,i=new BABYLON.NodeMaterial("node");i.mode=BABYLON.NodeMaterialModes.Material;const o=new BABYLON.InputBlock("position");o.visibleInInspector=!1,o.visibleOnFrame=!1,o.target=1,o.setAsAttribute("position");const h=new BABYLON.TransformBlock("WorldPos");h.visibleInInspector=!1,h.visibleOnFrame=!1,h.target=1,h.complementZ=0,h.complementW=1;const r=new BABYLON.InputBlock("World");r.visibleInInspector=!1,r.visibleOnFrame=!1,r.target=1,r.setAsSystemValue(BABYLON.NodeMaterialSystemValues.World);const a=new BABYLON.TransformBlock("World normal");a.visibleInInspector=!1,a.visibleOnFrame=!1,a.target=1,a.complementZ=0,a.complementW=0;const c=new BABYLON.InputBlock("normal");c.visibleInInspector=!1,c.visibleOnFrame=!1,c.target=1,c.setAsAttribute("normal");const B=new BABYLON.LightBlock("Lights");B.visibleInInspector=!1,B.visibleOnFrame=!1,B.target=3;const l=new BABYLON.InputBlock("cameraPosition");l.visibleInInspector=!1,l.visibleOnFrame=!1,l.target=1,l.setAsSystemValue(BABYLON.NodeMaterialSystemValues.CameraPosition);const w=new BABYLON.MultiplyBlock("Multiply");w.visibleInInspector=!1,w.visibleOnFrame=!1,w.target=4;const d=new BABYLON.GradientBlock("Gradient");d.visibleInInspector=!1,d.visibleOnFrame=!1,d.target=4,d.colorSteps=[],d.colorSteps.push(new BABYLON.GradientBlockColorStep(0,e)),d.colorSteps.push(new BABYLON.GradientBlockColorStep(1,s));const u=new BABYLON.SimplexPerlin3DBlock("SimplexPerlin3D");u.visibleInInspector=!1,u.visibleOnFrame=!1,u.target=4;const N=new BABYLON.ScaleBlock("Scale");N.visibleInInspector=!1,N.visibleOnFrame=!1,N.target=4;const O=new BABYLON.InputBlock("Scale");O.visibleInInspector=!1,O.visibleOnFrame=!1,O.target=1,O.value=n,O.min=0,O.max=0,O.isBoolean=!1,O.matrixMode=0,O.animationType=BABYLON.AnimatedInputBlockTypes.None,O.isConstant=!0;const A=new BABYLON.FragmentOutputBlock("FragmentOutput");A.visibleInInspector=!1,A.visibleOnFrame=!1,A.target=2,A.convertToGammaSpace=!1,A.convertToLinearSpace=!1,A.useLogarithmicDepth=!1;const Y=new BABYLON.TransformBlock("WorldPos * ViewProjectionTransform");Y.visibleInInspector=!1,Y.visibleOnFrame=!1,Y.target=1,Y.complementZ=0,Y.complementW=1;const L=new BABYLON.InputBlock("ViewProjection");L.visibleInInspector=!1,L.visibleOnFrame=!1,L.target=1,L.setAsSystemValue(BABYLON.NodeMaterialSystemValues.ViewProjection);const p=new BABYLON.VertexOutputBlock("VertexOutput");return p.visibleInInspector=!1,p.visibleOnFrame=!1,p.target=1,o.output.connectTo(h.vector),r.output.connectTo(h.transform),h.output.connectTo(Y.vector),L.output.connectTo(Y.transform),Y.output.connectTo(p.vector),h.output.connectTo(B.worldPosition),c.output.connectTo(a.vector),r.output.connectTo(a.transform),a.output.connectTo(B.worldNormal),l.output.connectTo(B.cameraPosition),B.diffuseOutput.connectTo(w.left),h.xyz.connectTo(N.input),O.output.connectTo(N.factor),N.output.connectTo(u.seed),u.output.connectTo(d.gradient),d.output.connectTo(w.right),w.output.connectTo(A.rgb),i.addOutputNode(p),i.addOutputNode(A),i.build(),i},{TransformNode:g,Vector3:T}=BABYLON;class b{constructor(t){this.solved=!1,this.scene=t,this.parent=new g("Castle",this.scene),this.reset()}get model(){return this.parent}set position(t){this.parent.position=t}set scale(t){this.parent.scaling=t}isSolved(){return this.solved}reset(){[[-11.5,3,5,5,6,6],[-5.5,5,4,7,10,4],[0,5,3,4,10,6],[1.5,3,-3,9,6,6],[10.5,2.5,-4,9,5,4],[13.5,1,2,3,2,8],[14,2,7.5,4,4,3],[18.5,1.5,7.5,5,3,3],[22.5,1.5,8,3,3,4],[25,1,7.5,2,2,3],[22.5,1,1.5,3,2,9],[19.5,1,-4.5,9,2,3],[-5,12,4,8,4,2],[0,12,3,2,4,6],[6,3,7,12,6,4]].forEach((t,e)=>{const[s,n,i,o,h,r]=t,a=BABYLON.MeshBuilder.CreateTiledBox("castle-wall"+e,{width:o,height:h,depth:r,tileSize:2},this.scene);a.position=new T(s,n,i),a.material=O(!0,.5,this.scene),a.checkCollisions=!0,a.setParent(this.parent);const c=BABYLON.MeshBuilder.CreateTiledBox("castle-roof"+e,{width:o-.01,height:.3,depth:r-.01,tileSize:2},this.scene);c.setParent(this.parent),c.position=new T(s,.5*h+n+.15,i),c.material=L(this.scene)}),[[-14,3.5,10,4,7,5],[-14,6,2,1,2,2],[-13.5,6.5,6,.5,1.5,0],[-13.5,6.5,4,.5,1.5,0],[-11.5,6.5,2.5,.5,1.5,0],[-9,10,2,2,3,4],[-9,14,4,1,2,1],[-9,10,6,2,3,4],[-6.5,11.5,2.5,1,3,3],[-3,5,2,4,10,0],[-2,12,3,2,3,1],[-2,10,0,2,3,4],[0,14,0,1,2,1],[2,10,0,2,3,4],[-3,6,-6,1,2,1],[-2.5,7,-3,.5,2,0],[0,7,-5.5,.5,2,0],[3,7,-5.5,.5,2,0],[6,3,-6,4,6,4],[15,5,-6,1,2,2],[21,3,10,1,2,2],[24,1.5,10,2,3,3]].forEach((t,e)=>{const[s,n,i,o,h,a]=t,c=BABYLON.MeshBuilder.CreateCylinder("turret"+e,{height:h,diameter:o},this.scene);if(c.position=new T(s,n,i),c.material=O(!1,h/4,this.scene),c.checkCollisions=!0,c.setParent(this.parent),a){const t=BABYLON.MeshBuilder.CreateCylinder("turret"+e,{height:a,diameterBottom:1.1*o,diameterTop:0},this.scene);t.material=M({color1:"#043132",color2:r,scale:40}),t.position=new T(s,n+.5*(h+a),i),t.setParent(this.parent)}})}}class v{constructor(){this.animations=[],this.scene=null}static get Instance(){return v.t||(v.t=new v),v.t}initScene(t){this.scene||(this.scene=t,this.scene.registerBeforeRender(()=>{const t=Date.now();this.animations=this.animations.filter(e=>{const s=Math.min(Math.max((t-e.startTime)/(e.endTime-e.startTime),0),1);return e.endTime>t?(e.end.position&&(e.mesh.position=BABYLON.Vector3.Lerp(e.start.position,e.end.position,e.easeFunc.ease(s))),e.end.rotation&&(e.mesh.rotation=BABYLON.Vector3.Lerp(e.start.rotation,e.end.rotation,e.easeFunc.ease(s))),e.end.scaling&&(e.mesh.scaling=BABYLON.Vector3.Lerp(e.start.scaling,e.end.scaling,e.easeFunc.ease(s))),!0):(e.end.position&&(e.mesh.position=e.end.position),e.end.rotation&&(e.mesh.rotation=e.end.rotation),e.end.scaling&&(e.mesh.scaling=e.end.scaling),!1)})}))}animateTransform(t){const{mesh:e,end:s}=t,n=t.duration||1e3,i=t.delay||0,o=t.ease||new BABYLON.QuadraticEase,h=Date.now();this.animations.push({mesh:e,start:{position:e.position,rotation:e.rotation,scaling:e.scaling},end:s,easeFunc:o,startTime:h+i,endTime:h+i+n})}}function x(...t){return S.play(...t)}const S={volume:.3,sampleRate:44100,audioContext:new AudioContext,play(...t){return this.playSamples([this.buildSamples(...t)])},playSamples(t,e=1,s=1,n=0,i=!1){const o=this.audioContext.createBuffer(t.length,t[0].length,this.sampleRate),h=this.audioContext.createBufferSource();t.forEach((t,e)=>o.getChannelData(e).set(t)),h.buffer=o,h.playbackRate.value=s,h.loop=i;const r=this.audioContext.createGain();r.gain.value=this.volume*e,r.connect(this.audioContext.destination);const a=new StereoPannerNode(this.audioContext,{pan:n});return h.connect(a).connect(r),h.start(),h},buildSamples(t=1,e=.05,s=220,n=0,i=0,o=.1,h=0,r=1,a=0,c=0,B=0,l=0,w=0,d=0,u=0,N=0,O=0,A=1,Y=0,L=0,p=0){let f,m,M=this.sampleRate,g=2*Math.PI,T=Math.abs,b=t=>0>t?-1:1,v=a*=500*g/M/M,x=s*=(1+2*e*Math.random()-e)*g/M,S=0,y=0,E=0,C=1,V=[],$=0,z=0,R=0,D=g*T(p)*2/M,F=Math.cos(D),P=Math.sin(D)/2/2,I=1+P,k=-2*F/I,W=(1-P)/I,j=(1+b(p)*F)/2/I,H=-(b(p)+F)/I,G=j,q=0,U=0,J=0,K=0;for(c*=500*g/M**3,u*=g/M,B*=g/M,l*=M,w=w*M|0,t*=this.volume,f=(n=n*M||9)+(Y*=M)+(i*=M)+(o*=M)+(O*=M)|0;f>z;V[z++]=R*t)++E%(100*N|0)||(R=h?h>1?h>2?h>3?h>4?2*(r/2>$/g%1)-1:Math.sin($**3):Math.max(Math.min(Math.tan($),1),-1):1-(2*$/g%2+2)%2:1-4*T(Math.round($/g)-$/g):Math.sin($),R=(w?1-L+L*Math.sin(g*z/w):1)*(h>4?R:b(R)*T(R)**r)*(n>z?z/n:n+Y>z?1-(z-n)/Y*(1-A):n+Y+i>z?A:f-O>z?(f-z-O)/o*A:0),R=O?R/2+(O>z?0:(f-O>z?1:(f-z)/O)*V[z-O|0]/2/t):R,p&&(R=K=G*q+H*(q=U)+j*(U=R)-W*J-k*(J=K))),m=(s+=a+=c)*Math.cos(u*S++),$+=m+m*d*Math.sin(z**5),C&&++C>l&&(s+=B,x+=B,C=0),w&&!(++y%w)&&(s=x,a=v,C||=1);return V},getNote:(t=0,e=440)=>e*2**(t/12)},y=()=>x(2.07,0,130.81,.01,.26,.47,3,1.15,void 0,.1,void 0,void 0,.05,void 0,void 0,void 0,.14,.26,.15,.02),{TransformNode:E,MeshBuilder:C,Vector3:V}=BABYLON;let $=0;class z{constructor(t){this.setLines=t=>{this.billboard.material=f(t,this.scene)},this.setEndgame=()=>{this.billboard.material=f(["Thanks for playing!"],this.scene),this.billboard.rotation=V.Zero(),this.billboard.renderingGroupId=1},this.scene=t,this.parent=new E("InfoBillboard"+ ++$,t),this.billboard=C.CreatePlane("billboard",{width:3,height:1,sideOrientation:BABYLON.Mesh.DOUBLESIDE},t),this.billboard.setParent(this.parent),this.billboard.position=new V(0,.6,0),this.billboard.rotation.x=Math.PI/4}set position(t){this.parent.position=t}set rotation(t){this.billboard.rotation=t}get model(){return this.parent}}const{TransformNode:R,Vector3:D}=BABYLON;let F=0;const P=["Red cannot be next to","another Red"],I=["Number of flowers must be one","more or less than neighbor"],k=["Square must be placed","in a square shape"];class W{constructor(s,i){this.meshes=[],this.colors={R:t,G:e,B:"#1a85ff",Y:n,W:o,D:"#994f00"},this.solved=!1,this.scene=i,this.board=s.board,this.solvedEvent=s.solvedEvent,this.boardHeight=this.board.length,this.boardWidth=this.board[0].length,this.parent=new R("FlowerBoxPuzzle",this.scene),this.inventoryTransform=new R("Holding",this.scene);const h=i.getNodeByName("inventory-parent");this.inventoryTransform.setParent(h),this.inventoryTransform.position=D.Zero(),this.inventoryTransform.rotation=D.Zero(),this.selectedMesh=null,this.messageBoard=new z(this.scene),this.messageBoard.setLines([]),this.messageBoard.model.setParent(this.parent),this.messageBoard.model.position=new D(.5*this.boardWidth,0,.5),this.reset()}get model(){return this.parent}set position(t){this.parent.position=t}set scale(t){this.parent.scaling=t}cellAt(t,e,s){try{const n=this.board[e][t];return s&&(this.board[e][t]=s),n}catch{return null}}boardPos(t,e){return new D(1*t+.5,0,-1*e-.5)}groupedCellCount(t,e){const s=[`${t},${e}`],n=this.cellAt(t,e);let i=0;for(let t=0;s.length>t;t++){const[e,o]=s[t].split(","),h=parseInt(e),r=parseInt(o);this.cellAt(h,r)===n&&(i+=1,s.push(...[`${h+1},${r}`,`${h-1},${r}`,`${h},${r+1}`,`${h},${r-1}`].filter(t=>!s.includes(t))))}return i}isSolved(){if(this.solved)return!0;let t=!1;if(this.selectedMesh&&"D"!==this.selectedMesh.metadata.color&&(this.messageBoard.setLines([]),t=!0),t)return;let e=0;const s=[];let n=Number.MAX_SAFE_INTEGER,i=-1,o=Number.MAX_SAFE_INTEGER,h=-1;return this.board.forEach((r,a)=>{t||r.forEach((r,c)=>{if(t)return;const[B,l,w]=r.split(""),d=[this.cellAt(c+1,a),this.cellAt(c-1,a),this.cellAt(c,a+1),this.cellAt(c,a-1)];"R"===l&&d.some(t=>"R"===t?.split("")[1])&&(this.messageBoard.setLines(P),t=!0),!t&&(parseInt(B)>0&&(d.every(t=>{if(!t)return!0;const[e,s,n]=t?.split("");return 0===parseInt(e)||parseInt(B)===parseInt(e)-1||parseInt(B)===parseInt(e)+1})||(this.messageBoard.setLines(I),t=!0)),"C"===w&&(e+=1,n=Math.min(n,c),i=Math.max(i,c),o=Math.min(o,a),h=Math.max(h,a),s.push({x:c,y:a})))})}),e>0&&4>e&&(t=!0),s.every(t=>!(t.x!==n&&t.x!==i||t.y!==o&&t.y!==h))||(this.messageBoard.setLines(k),t=!0),t||(this.solved=!0),this.solved&&(y(),this.messageBoard.setLines(["COMPLETE"]),this.solvedEvent&&this.solvedEvent()),this.solved}swapMesh(t){const e=t.metadata||{},{x:s,y:n}=e;this.cellAt(s,n,this.selectedMesh?`${this.selectedMesh.metadata.count}${this.selectedMesh.metadata.color}${this.selectedMesh.metadata.shape}`:""),this.selectedMesh&&(this.selectedMesh.metadata={...this.selectedMesh.metadata,picked:!1,x:s,y:n},this.placeFlower(this.selectedMesh),this.selectedMesh=null),t.metadata={...t.metadata,picked:!0},this.selectedMesh=t,this.placeFlower(this.selectedMesh),this.isSolved()}createFlower(t,s,n,i,o){const h=new BABYLON.Mesh("flower",this.scene);h.metadata={count:t,color:s,shape:n,x:i,y:o},h.onPointerPick=()=>{x(1.01,void 0,275,.01,.01,.15,1,1.03,-3.7,void 0,-93,.07,void 0,void 0,void 0,-.1,void 0,.5,.04,.09),!this.solved&&this.swapMesh(h)};for(let i=0;t>i;i++){const o=BABYLON.MeshBuilder.CreateCylinder("stem"+ ++F,{height:.4,diameter:.1},this.scene);let r;o.setParent(h),o.position.y=.2,r="T"===n?BABYLON.MeshBuilder.CreateCylinder("head"+ ++F,{diameterBottom:0,diameterTop:.4,height:.4,tessellation:3},this.scene):"S"===n?BABYLON.MeshBuilder.CreateSphere("head"+ ++F,{diameter:.3},this.scene):BABYLON.MeshBuilder.CreateBox("head"+ ++F,{size:.25},this.scene),r.setParent(o),r.position=new D(0,.3,0),r.material=A(this.colors[s],this.scene),o.position=new D(0,.2,0),t>1&&o.rotateAround(D.Zero(),D.Right(),Math.PI/8),o.rotateAround(D.Zero(),D.Up(),2*i*Math.PI/t),o.material=A(e,this.scene)}const r=BABYLON.MeshBuilder.CreateCylinder("leaf",{diameter:.3,height:.1},this.scene);return r.setParent(h),r.position=new D(.15,.15,0),r.material=A(e,this.scene),h}createBush(){const t=new BABYLON.Mesh("bush",this.scene),n=BABYLON.MeshBuilder.CreateBox("head",{height:.2,width:.9,depth:.9},this.scene);return n.setParent(t),n.position=new D(0,.1,0),n.material=M({color1:e,color2:s,scale:100}),t}createEmpty(t,e){const s=new BABYLON.Mesh("empty",this.scene);s.onPointerPick=()=>{this.solved||this.swapMesh(s)},s.metadata={count:1,color:"D",shape:"",x:t,y:e};const n=BABYLON.MeshBuilder.CreateBox("head",{height:.2,width:.4,depth:.4},this.scene);return n.setParent(s),n.position=new D(0,.1,0),n.material=A(this.colors.D,this.scene),s}placeFlower(t){if(t.metadata.picked)return t.setParent(this.inventoryTransform),v.Instance.animateTransform({mesh:t,end:{position:D.Zero(),rotation:D.Zero(),scaling:new D(.25,.25,.25)},duration:200}),t.renderingGroupId=1,t.isPickable=!1,void t.setEnabled("D"!==t.metadata.color);const{x:e,y:s}=t.metadata;t.setParent(this.parent),v.Instance.animateTransform({mesh:t,end:{position:this.boardPos(e,s),rotation:D.Zero(),scaling:D.One()},duration:200}),t.isPickable=!0,t.setEnabled(!0),t.renderingGroupId=0}reset(){this.meshes.forEach(t=>{t.dispose()}),this.selectedMesh=null;const t=BABYLON.MeshBuilder.CreateGround("flower-puzzle-ground",{width:this.boardWidth,height:this.boardHeight});t.material=((t,e,s,n,i)=>{const o=`grid-${t}-${e}-${s}-${n}`;if(N[o])return N[o];const[h,r]=l(512);r.imageSmoothingEnabled=!1;const a=512/s,c=512/n;r.fillStyle=t,r.fillRect(0,0,h.width,h.height),r.fillStyle=e;for(let t=0;n>t;t++)for(let e=0;s>e;e++)(e+t)%2||r.fillRect(e*a,t*c,a,c);const B=new w("material"+ ++u,i),O=d.LoadFromDataString("texture"+ ++u,h.toDataURL(),i);return B.diffuseTexture=O,N[o]=B,B})(e,s,this.boardWidth,this.boardHeight,this.scene),t.setParent(this.parent),t.position=new D(.5*this.boardWidth,.02,-.5*this.boardHeight);for(let t=-1;this.boardHeight+1>t;t++)for(let e=-1;this.boardWidth+1>e;e++){if(t>=0&&this.boardHeight>t&&e>=0&&this.boardWidth>e)continue;const s=this.createBush();s.setParent(this.parent),s.name=`bush${e},${t}`,s.position=this.boardPos(e,t)}this.board.forEach((t,e)=>{t.forEach((t,s)=>{let n;const[i,o,h]=t.split("");switch(o){case"":return;case"R":case"Y":case"B":case"W":n=this.createFlower(parseInt(i),o,h,s,e),n.name=`cell${s}-${e}`,this.placeFlower(n)}})}),this.selectedMesh=this.createEmpty(-1,-1),this.selectedMesh.metadata={...this.selectedMesh.metadata,picked:!0},this.placeFlower(this.selectedMesh),this.solved=!1}}const j=t=>{const e=t.baseColor?BABYLON.Color4.FromHexString(t.baseColor+"FF"):BABYLON.Color4.FromHexString("#243DA6FF"),s=t.rippleColor?BABYLON.Color4.FromHexString(t.rippleColor+"FF"):BABYLON.Color4.FromHexString("#0AD6E0FF"),n=t.frozen||!1,i=new BABYLON.NodeMaterial("node"),o=new BABYLON.InputBlock("position");o.visibleInInspector=!1,o.visibleOnFrame=!1,o.target=1,o.setAsAttribute("position");const h=new BABYLON.TransformBlock("WorldPos");h.visibleInInspector=!1,h.visibleOnFrame=!1,h.target=1,h.complementZ=0,h.complementW=1;const r=new BABYLON.InputBlock("World");r.visibleInInspector=!1,r.visibleOnFrame=!1,r.target=1,r.setAsSystemValue(BABYLON.NodeMaterialSystemValues.World);const a=new BABYLON.TransformBlock("WorldPos * ViewProjectionTransform");a.visibleInInspector=!1,a.visibleOnFrame=!1,a.target=1,a.complementZ=0,a.complementW=1;const c=new BABYLON.InputBlock("ViewProjection");c.visibleInInspector=!1,c.visibleOnFrame=!1,c.target=1,c.setAsSystemValue(BABYLON.NodeMaterialSystemValues.ViewProjection);const B=new BABYLON.VertexOutputBlock("VertexOutput");B.visibleInInspector=!1,B.visibleOnFrame=!1,B.target=1;const l=new BABYLON.InputBlock("TwirlCenter");l.visibleInInspector=!1,l.visibleOnFrame=!1,l.target=1,l.value=new BABYLON.Vector2(.5,.5),l.isConstant=!1;const w=new BABYLON.VectorSplitterBlock("VectorSplitter");w.visibleInInspector=!1,w.visibleOnFrame=!1,w.target=4;const d=new BABYLON.AddBlock("Add");d.visibleInInspector=!1,d.visibleOnFrame=!1,d.target=1;const u=new BABYLON.VectorMergerBlock("VectorMerger");u.visibleInInspector=!1,u.visibleOnFrame=!1,u.target=1,u.xSwizzle="x",u.ySwizzle="y",u.zSwizzle="z",u.wSwizzle="w";const N=new BABYLON.SubtractBlock("Subtract (x)");N.visibleInInspector=!1,N.visibleOnFrame=!1,N.target=1;const O=new BABYLON.MultiplyBlock("Multiply");O.visibleInInspector=!1,O.visibleOnFrame=!1,O.target=1;const A=new BABYLON.TrigonometryBlock("Cos");A.visibleInInspector=!1,A.visibleOnFrame=!1,A.target=4,A.operation=BABYLON.TrigonometryBlockOperations.Cos;const Y=new BABYLON.MultiplyBlock("Strength x Delta Lergth");Y.visibleInInspector=!1,Y.visibleOnFrame=!1,Y.target=1;const L=new BABYLON.InputBlock("TwirlStrength");L.visibleInInspector=!1,L.visibleOnFrame=!1,L.target=1,L.value=2,L.min=0,L.max=0,L.isBoolean=!1,L.matrixMode=0,L.animationType=BABYLON.AnimatedInputBlockTypes.None,L.isConstant=!1;const p=new BABYLON.LengthBlock("Delta (Length)");p.visibleInInspector=!1,p.visibleOnFrame=!1,p.target=1;const f=new BABYLON.SubtractBlock("Delta (Subtract)");f.visibleInInspector=!1,f.visibleOnFrame=!1,f.target=1;const m=new BABYLON.InputBlock("uv");m.visibleInInspector=!1,m.visibleOnFrame=!1,m.target=1,m.setAsAttribute("uv");const M=new BABYLON.VectorSplitterBlock("VectorSplitter");M.visibleInInspector=!1,M.visibleOnFrame=!1,M.target=1;const g=new BABYLON.MultiplyBlock("Multiply");g.visibleInInspector=!1,g.visibleOnFrame=!1,g.target=1;const T=new BABYLON.TrigonometryBlock("Sin");T.visibleInInspector=!1,T.visibleOnFrame=!1,T.target=1,T.operation=BABYLON.TrigonometryBlockOperations.Sin;const b=new BABYLON.AddBlock("Add (y)");b.visibleInInspector=!1,b.visibleOnFrame=!1,b.target=1;const v=new BABYLON.MultiplyBlock("Multiply");v.visibleInInspector=!1,v.visibleOnFrame=!1,v.target=1;const x=new BABYLON.TrigonometryBlock("Cos");x.visibleInInspector=!1,x.visibleOnFrame=!1,x.target=1,x.operation=BABYLON.TrigonometryBlockOperations.Cos;const S=new BABYLON.MultiplyBlock("Multiply");S.visibleInInspector=!1,S.visibleOnFrame=!1,S.target=1;const y=new BABYLON.TrigonometryBlock("Sin");y.visibleInInspector=!1,y.visibleOnFrame=!1,y.target=4,y.operation=BABYLON.TrigonometryBlockOperations.Sin;const E=new BABYLON.VoronoiNoiseBlock("VoronoiNoise");E.visibleInInspector=!1,E.visibleOnFrame=!1,E.target=4;const C=new BABYLON.AddBlock("Add");C.visibleInInspector=!1,C.visibleOnFrame=!1,C.target=4;const V=new BABYLON.InputBlock("Time");V.visibleInInspector=!1,V.visibleOnFrame=!1,V.target=1,V.value=0,V.min=0,V.max=0,V.isBoolean=!1,V.matrixMode=0,V.animationType=n?BABYLON.AnimatedInputBlockTypes.None:BABYLON.AnimatedInputBlockTypes.Time,V.isConstant=n;const $=new BABYLON.InputBlock("Offset");$.visibleInInspector=!1,$.visibleOnFrame=!1,$.target=1,$.value=666,$.min=0,$.max=0,$.isBoolean=!1,$.matrixMode=0,$.animationType=BABYLON.AnimatedInputBlockTypes.None,$.isConstant=!0;const z=new BABYLON.InputBlock("Scale");z.visibleInInspector=!1,z.visibleOnFrame=!1,z.target=1,z.value=12,z.min=0,z.max=0,z.isBoolean=!1,z.matrixMode=0,z.animationType=BABYLON.AnimatedInputBlockTypes.None,z.isConstant=!1;const R=new BABYLON.ColorMergerBlock("ColorMerger");R.visibleInInspector=!1,R.visibleOnFrame=!1,R.target=4,R.rSwizzle="r",R.gSwizzle="g",R.bSwizzle="b",R.aSwizzle="a";const D=new BABYLON.InputBlock("ColorAlpha");D.visibleInInspector=!1,D.visibleOnFrame=!1,D.target=1,D.value=1,D.min=0,D.max=0,D.isBoolean=!1,D.matrixMode=0,D.animationType=BABYLON.AnimatedInputBlockTypes.None,D.isConstant=!0;const F=new BABYLON.MultiplyBlock("Multiply");F.visibleInInspector=!1,F.visibleOnFrame=!1,F.target=4;const P=new BABYLON.InputBlock("RippleColor");P.visibleInInspector=!1,P.visibleOnFrame=!1,P.target=1,P.value=s,P.isConstant=!1;const I=new BABYLON.MaxBlock("Max");I.visibleInInspector=!1,I.visibleOnFrame=!1,I.target=4;const k=new BABYLON.InputBlock("BaseColor");k.visibleInInspector=!1,k.visibleOnFrame=!1,k.target=1,k.value=e,k.isConstant=!1;const W=new BABYLON.FragmentOutputBlock("FragmentOutput");W.visibleInInspector=!1,W.visibleOnFrame=!1,W.target=2,W.convertToGammaSpace=!1,W.convertToLinearSpace=!1,W.useLogarithmicDepth=!1;const j=new BABYLON.InputBlock("Opacity");return j.visibleInInspector=!1,j.visibleOnFrame=!1,j.target=1,j.value=1,j.min=0,j.max=0,j.isBoolean=!1,j.matrixMode=0,j.animationType=BABYLON.AnimatedInputBlockTypes.None,j.isConstant=!1,o.output.connectTo(h.vector),r.output.connectTo(h.transform),h.output.connectTo(a.vector),c.output.connectTo(a.transform),a.output.connectTo(B.vector),l.output.connectTo(w.xyIn),w.xyOut.connectTo(d.left),L.output.connectTo(Y.left),m.output.connectTo(f.left),w.xyOut.connectTo(f.right),f.output.connectTo(p.value),p.output.connectTo(Y.right),Y.output.connectTo(A.input),A.output.connectTo(O.left),f.output.connectTo(M.xyIn),M.x.connectTo(O.right),O.output.connectTo(N.left),Y.output.connectTo(y.input),y.output.connectTo(S.left),M.y.connectTo(S.right),S.output.connectTo(N.right),N.output.connectTo(u.x),M.x.connectTo(g.left),Y.output.connectTo(T.input),T.output.connectTo(g.right),g.output.connectTo(b.left),Y.output.connectTo(x.input),x.output.connectTo(v.left),M.y.connectTo(v.right),v.output.connectTo(b.right),b.output.connectTo(u.y),u.xy.connectTo(d.right),d.output.connectTo(E.seed),V.output.connectTo(C.left),$.output.connectTo(C.right),C.output.connectTo(E.offset),z.output.connectTo(E.density),E.output.connectTo(R.r),E.output.connectTo(R.g),E.output.connectTo(R.b),D.output.connectTo(R.a),R.rgba.connectTo(F.left),P.output.connectTo(F.right),F.output.connectTo(I.left),k.output.connectTo(I.right),I.output.connectTo(W.rgba),j.output.connectTo(W.a),i.addOutputNode(B),i.addOutputNode(W),i.build(),i},{TransformNode:H,MeshBuilder:G,Vector3:q}=BABYLON;let U=0;const{TransformNode:J,Vector3:K,MeshBuilder:Q}=BABYLON;class X{constructor(t){this.solved=!1,this.solvedCount=0,this.scene=t,this.puzzles=[],this.floors=[],this.parent=new J("Garden",this.scene),this.endgameSphere=null,this.reset()}get model(){return this.parent}set position(t){this.parent.position=t}set scale(t){this.parent.scaling=t}isSolved(){if(this.solved)return!0;this.solvedCount=0;for(let t=0;this.puzzles.length>t;t++)this.puzzles[t].solved&&(this.solvedCount+=1);if(this.solved=this.puzzles.length>0&&this.solvedCount===this.puzzles.length,this.solved){if(!this.endgameSphere)return;this.endgameSphere.setEnabled(!0),this.endgameSphere.scaling=K.Zero(),v.Instance.animateTransform({mesh:this.endgameSphere,end:{scaling:new K(1,1,1)},ease:new BABYLON.ExponentialEase(2),duration:1e3})}return this.solved}reset(){this.floors=[];const e=Q.CreateTiledGround("Garden-ground",{xmin:-18,xmax:18,zmin:-6,zmax:10,subdivisions:{h:12,w:24}},this.scene);e.material=(t=>{const e="dirt";if(N[e])return N[e];const[s,n]=l(256);n.fillStyle="#6d4d41",n.fillRect(0,0,s.width,s.height),n.fillStyle="#49332b";for(let t=0;12>t;t++){const t=Math.random()*(s.width-12),e=Math.random()*(s.height-12);n.fillRect(t,e,12,12)}const i=Y(s,t);return N[e]=i,i})(this.scene),e.setParent(this.parent),e.position=new K(0,.01,0),this.floors.push(e),Q.CreateTorus("fountain-edge",{diameter:4,thickness:1,tessellation:32},this.scene).setParent(this.parent);const s=Q.CreateCylinder("fountain-water",{diameter:4,height:1,tessellation:32});s.material=j({}),s.checkCollisions=!0,s.setParent(this.parent);const i=Q.CreateTorusKnot("fountain-statue",{tube:.1,radialSegments:128,p:5,q:2},this.scene);i.setParent(this.parent);const o=new K(0,1.5,0);i.position=o,i.rotation.x=Math.PI/2,i.scaling=new K(.5,.5,1.5),i.isPickable=!1,i.registerBeforeRender(t=>{this.solvedCount>0&&t.rotateAround(o,K.Up(),Math.PI/1700*this.scene.getEngine().getDeltaTime()),this.solvedCount>1&&t.rotateAround(o,K.Right(),Math.PI/800*this.scene.getEngine().getDeltaTime()),this.solvedCount>2&&t.rotateAround(o,K.Forward(),Math.PI/500*this.scene.getEngine().getDeltaTime())});const h=(e=>{const s=new H("Crown"+ ++U,e),i=[new q(.4,0,0),new q(.4,.1,0),new q(-.4,.1,0),new q(-.4,0,0)],o=[new q(3,2,0),new q(3,4,0),new q(2,5,0),new q(0,5,0),new q(-2,5,0),new q(-3,4,0),new q(-3,2,0)],h=[new q(3.4,0,0),new q(3.4,2,0),new q(3,2,0),new q(3,0,0)],a=G.ExtrudeShape("arch",{shape:i,path:o,closeShape:!0,cap:BABYLON.Mesh.CAP_ALL},e);a.material=A(n,e),a.setParent(s),a.clone("arch2").rotateAround(q.Zero(),q.Up(),Math.PI/2);const c=BABYLON.MeshBuilder.CreateLathe("cloth",{shape:o,radius:0,arc:.5,closed:!1,tessellation:12,sideOrientation:BABYLON.Mesh.DOUBLESIDE},e);c.material=M({color1:t,color2:r,scale:2}),c.setParent(s),c.scaling=new q(.95,.95,.95);const B=BABYLON.MeshBuilder.CreateSphere("crown-ball",{diameter:1},e);B.material=A(n,e),B.setParent(s),B.position.y=5.5;const l=BABYLON.MeshBuilder.CreateLathe("cloth",{shape:h,radius:0,closed:!0,tessellation:12,sideOrientation:BABYLON.Mesh.DOUBLESIDE},e);return l.material=A(n,e),l.setParent(s),s.scaling=new q(.25,.25,.25),s.getChildMeshes().forEach(t=>{t.renderingGroupId=1}),s})(this.scene);h.scaling=K.Zero(),h.setParent(this.parent);const a=new z(this.scene);this.endgameSphere=Q.CreateSphere("endgame-sphere",{diameter:1,sideOrientation:BABYLON.Mesh.DOUBLESIDE},this.scene),this.endgameSphere.material=A(r,this.scene),this.endgameSphere.renderingGroupId=1,this.endgameSphere.setParent(this.parent),this.endgameSphere.position.y=1.5,this.endgameSphere.onPointerPick=()=>{y(),v.Instance.animateTransform({mesh:this.endgameSphere,end:{scaling:new K(100,100,100)},ease:new BABYLON.ExponentialEase(2),duration:1e4}),v.Instance.animateTransform({mesh:h,end:{scaling:new K(.15,.15,.15)},duration:1e3,delay:500}),v.Instance.animateTransform({mesh:a.model,end:{scaling:K.One()},duration:1e3,delay:1e3})},c||this.endgameSphere.setEnabled(!1),h.position=this.endgameSphere.position,a.setEndgame(),a.model.setParent(this.parent),a.model.position=this.endgameSphere.position.add(new K(0,1.5,0)),a.model.scaling=K.Zero();const B=[[["1RT","1RT"],["2BT","2BT"]],[["0ET","2RC","0ET","0ET","1BS"],["2RC","0ET","1BS","0ET","0ET"],["0ET","2RC","0ET","1BS","0ET"],["2RC","0ET","1BS","0ET","1BS"],["0ET","1BS","0ET","0ET","0ET"]],[["3YT"],["1YT"],["1YT"],["2YT"],["2YT"]],[["0ET","0ET","3BS","0ET","0ET"],["0ET","2RS","3BC","3BS","0ET"],["2RS","2BS","1RC","3BC","1BS"],["0ET","1RS","3BS","1BC","0ET"],["0ET","0ET","2BS","0ET","0ET"]]],w=[new K(-15,0,6),new K(-9,0,2),new K(4,0,2),new K(9,0,5)];for(let t=0;B.length>t;t++){const e=w[t],s=new W({board:B[t],solvedEvent:()=>{this.isSolved()}},this.scene);s.model.setParent(this.parent),s.position=e,s.isSolved(),this.puzzles.push(s)}this.solved=!1}}const{TransformNode:Z,MeshBuilder:_,Vector3:tt}=BABYLON;let et=0;const{TransformNode:st,Vector3:nt}=BABYLON;class it{constructor(t,e){this.solved=!1,this.updateDials=()=>{this.dials.forEach(t=>{const e=2*Math.PI/this.alphabet.length;v.Instance.animateTransform({mesh:t,end:{rotation:new nt(0,.5*Math.PI+.5*e+parseInt(t.metadata.alphabetIndex,10)*e,0)},duration:60})})},this.scene=e,this.alphabet=t.alphabet?.split("")||Array.from("0123456789"),this.code=t.code?.split("")||Array.from("123"),this.guess=Array.from(this.alphabet[0].repeat(this.code.length)),this.parent=new st("DialPuzzle",this.scene),this.parent.position=nt.Zero(),this.dials=[],this.solvedEvent=t.solvedEvent?t.solvedEvent:()=>{},this.reset()}get model(){return this.parent}set scale(t){this.parent.scaling=t}isSolved(){return!!this.solved||(this.solved=this.code.every((t,e)=>this.guess[e]===t),this.solved&&(y(),this.solvedEvent()),this.solved)}reset(){this.solved=!1,this.dials=[];const t=this.code.length,e=1*Math.sin(Math.PI/this.alphabet.length);for(let s=0;t>s;s++){const n=[];n[0]=new BABYLON.Vector4(0,0,0,0),n[1]=new BABYLON.Vector4(1,0,0,1),n[2]=new BABYLON.Vector4(0,0,0,0);const i=BABYLON.MeshBuilder.CreateCylinder("dial-"+s,{height:e,diameter:1,faceUV:n,tessellation:this.alphabet.length},this.scene);i.onPointerPick=()=>{if(x(void 0,void 0,76,.02,.02,.01,1,.44,void 0,void 0,void 0,void 0,void 0,.5,void 0,void 0,void 0,void 0,.01,.57),this.solved)return;const{index:t,alphabetIndex:e}=i.metadata,n=e+1;i.metadata={index:s,alphabetIndex:n},this.guess[t]=this.alphabet[n%this.alphabet.length],this.updateDials(),this.isSolved()},i.setParent(this.parent),i.position=new nt(0,(t-s-1)*(e+.05)+.15,0),i.material=p(this.alphabet,this.scene),i.metadata={index:s,alphabetIndex:0},this.dials.push(i)}const s=BABYLON.MeshBuilder.CreateBox("dial-align",{height:(e+.05)*(t+1),width:.2,depth:.2});s.setParent(this.parent),s.position=new nt(0,.15*t,-.26),s.material=A(a,this.scene);const n=BABYLON.MeshBuilder.CreatePlane("dial-banner",{},this.scene);n.setParent(this.parent),n.position=new nt(0,.15*t+2,-.26),n.material=m(this.scene),this.updateDials()}}const{TransformNode:ot,MeshBuilder:ht,Vector3:rt}=BABYLON;let at=0;const{TransformNode:ct,MeshBuilder:Bt,Vector3:lt}=BABYLON;let wt=0;const dt=t=>{const e=new ct("Banner"+ ++wt,t),s=Bt.CreateGround("symbols",{width:4,height:4,subdivisions:12,updatable:!0},t);s.setParent(e),s.position=new lt(0,2,0),s.rotation.x=3*Math.PI/2,s.material=m(t);let n=0;return s.registerBeforeRender(e=>{n+=t.getEngine().getDeltaTime();const s=e.getVerticesData(BABYLON.VertexBuffer.PositionKind);if(s){for(let t=0;s?.length>t;t+=3)s[t+1]=.1*(s[t+2]-2)*Math.sin(.8*n/100+s[t+2]);e.updateVerticesData(BABYLON.VertexBuffer.PositionKind,s)}}),e},{TransformNode:ut,MeshBuilder:Nt,Vector3:Ot}=BABYLON;let At=0;const{MeshBuilder:Yt,TransformNode:Lt,Vector3:pt}=BABYLON;class ft{constructor(t){this.solved=!1,this.scene=t,this.puzzles=[],this.floors=[],this.bushes=[],this.trees=[],this.parent=new Lt("Entrance",this.scene),this.reset()}get model(){return this.parent}set position(t){this.parent.position=t}set scale(t){this.parent.scaling=t}isSolved(){return!!this.solved||(this.solved=this.puzzles.length>0&&this.puzzles.every(t=>t.solved),this.solved&&(this.bushes.forEach(t=>{-14>t.position.z||t.position.z>-12||v.Instance.animateTransform({mesh:t,end:{position:t.position.add(new pt(0,3,0))},duration:4e3,delay:3e3})}),this.door&&v.Instance.animateTransform({mesh:this.door,end:{rotation:this.door.rotation.add(new pt(-1*Math.PI/2,0,0))},duration:5e3})),this.solved)}reset(){this.floors=[];const t=Yt.CreateTiledGround("ground",{xmin:-10,xmax:12,zmin:-20,zmax:12,subdivisions:{w:11,h:16}});t.setParent(this.parent),t.material=L(this.scene),t.position.y=-.01,t.position=new pt(0,.01,0);const e=[{shape:"box",count:3},{shape:"sphere",count:5},{shape:"triangle",count:4}];e.forEach((t,e)=>{const s=((t,e)=>{const s=new Z("Tree"+ ++et,e),n=t.count||3,i=t.shape||"box",o=_.CreateCylinder("trunk"+ ++et,{diameter:.5,height:3,tessellation:6});o.material=M({color1:"#332211",color2:"#593b1d",scale:5}),o.setParent(s),o.position=new tt(0,1.5,0);for(let t=0;n>t;t++){let s;switch(i){case"box":s=_.CreateBox("shape"+ ++et,{size:1.5},e);break;case"triangle":s=_.CreateCylinder("shape"+ ++et,{diameterTop:0,diameterBottom:4,tessellation:3},e);break;case"sphere":s=_.CreateSphere("shape"+ ++et,{diameter:2},e)}if(!s)return;s.material=M({color1:"#00ff00",color2:"#332211",scale:25}),s.setParent(o),s.position.y=.75*t+.5,s.position.x=.25*(n-t),s.rotation=new tt(2*Math.random()*Math.PI,2*Math.random()*Math.PI,2*Math.random()*Math.PI),s.rotateAround(tt.Zero(),tt.Up(),2*Math.random()*Math.PI)}return s})(t,this.scene);s&&(s.setParent(this.parent),s.position=new pt(0,0,-4*e+4),this.trees.push(s))});const s=new it({code:e.map(t=>t.count).join(""),alphabet:"012345",solvedEvent:()=>{this.isSolved()}},this.scene);s.model.setParent(this.parent),s.model.position=new pt(7.5,.5,11.5),s.model.rotation=new pt(0,Math.PI/4,0),this.puzzles.push(s);const n=(t=>{const e=new ot("Door"+ ++at,t),s=[new rt(2,0,0),new rt(2,2,0),new rt(1.74,3,0),new rt(1,3.74,0),new rt(0,4,0),new rt(-1,3.74,0),new rt(-1.74,3,0),new rt(-2,2,0),new rt(-2,0,0)],n=[new rt(0,0,.5),new rt(0,0,-.5)],o=[new rt(.51,-.1,0),new rt(.51,0,0),new rt(-.51,0,0),new rt(-.51,-.1,0)],h=[new rt(0,0,0),new rt(0,4,0)],r=[new rt(.1,0,0),new rt(.2,0,0),new rt(.2,.05,0),new rt(.1,.05,0)],c=[new rt(1,.5,0),new rt(0,.5,0),new rt(0,1,0),new rt(-1,0,0),new rt(0,-1,0),new rt(0,-.5,0),new rt(1,-.5,0)],B=ht.ExtrudeShape("door",{shape:s,path:n,closeShape:!0,cap:BABYLON.Mesh.CAP_ALL},t);B.material=M({color1:"#332211",color2:"#593b1d",scale:5}),B.setParent(e);const l=ht.ExtrudeShape("frame",{shape:o,path:s,closeShape:!0,cap:BABYLON.Mesh.CAP_ALL},t);l.material=A("#888888",t),l.setParent(e);const w=ht.ExtrudeShape("frame",{shape:o,path:h,closeShape:!0,cap:BABYLON.Mesh.CAP_ALL},t);w.material=A("#000000",t),w.setParent(e);const d=BABYLON.MeshBuilder.CreateLathe("handle",{shape:r,radius:1,closed:!0,tessellation:12,sideOrientation:BABYLON.Mesh.DOUBLESIDE},t);d.material=A("#000000",t),d.setParent(e),d.rotation.x=Math.PI/2,d.position=new rt(-.5,1,-.55),d.clone("handle2").position.x*=-1;const u=ht.ExtrudeShape("door",{shape:c,path:n,closeShape:!0,cap:BABYLON.Mesh.CAP_ALL},t);return u.setParent(e),u.position=new rt(0,1,-1),u.material=j({baseColor:a,rippleColor:i}),u.rotateAround(new rt(0,0,-1),rt.Up(),Math.PI/4),u.rotateAround(new rt(0,0,1),rt.Right(),Math.PI/2),e})(this.scene);n.setParent(this.parent),n.position=new pt(9.5,0,9.5),n.rotation=new pt(0,Math.PI/4,0),this.door=n;const o=dt(this.scene);o.setParent(this.parent),o.position=new pt(-5,8,11.5);const h=dt(this.scene);h.setParent(this.parent),h.position=new pt(11.6,8,0),h.rotation=new pt(0,Math.PI/2,0),this.floors.push(t);const r=(t=>{const e=new ut("Door"+ ++At,t),s=Nt.CreateBox("Bush"+ ++At,{width:.95,depth:.95,height:3},t);return s.setParent(e),s.position=new Ot(0,1.5,0),s.material=M({color1:"#00ff00",color2:"#ff00ff",scale:60}),s.checkCollisions=!0,e})(this.scene);for(let t=0;16>t;t++){const e=r.clone("Bush"+t,this.parent,!1);e&&(e.position=new pt(12.5,0,-19.5+t),this.bushes.push(e),c&&e.setEnabled(!1))}r.dispose(),this.solved=!1}}const{Engine:mt,Scene:Mt,MeshBuilder:gt,HemisphericLight:Tt,UniversalCamera:bt,Vector3:vt,PointerEventTypes:xt}=BABYLON,St=async()=>{let t=!1;document.getElementById("intro").style.display="none";const e=document.getElementById("c");e.style.display="block",e.addEventListener("click",async()=>{await e.requestPointerLock({unadjustedMovement:!0})});const s=new mt(e,!0),n=new Mt(s);v.Instance.initScene(n),n.gravity=new vt(0,-.15,0),n.collisionsEnabled=!0,c&&n.debugLayer.show({embedMode:!0}),s.displayLoadingUI();const i=new bt("MainCamera",new vt(-23,1.615,13.5),n);i.inertia=0,i.speed=3,i.keysUp.push(87),i.keysDown.push(83),i.keysLeft.push(65),i.keysRight.push(68),i.keysUpward.push(69),i.keysDownward.push(81),i.attachControl(e,!0),i.angularSensibility=500,i.applyGravity=!0,i.ellipsoid=new vt(.4,.8,.4),i.checkCollisions=!0,i.minZ=.1,n.onPointerObservable.add(e=>{if(e.type!==xt.POINTERDOWN||!n||!t&&0!==e.event.button)return;let i=(t?e.pickInfo:n.pick(s.getRenderWidth()/2,s.getRenderHeight()/2))?.pickedMesh;for(;i&&!i.onPointerPick;)i=i.parent;i&&i.onPointerPick&&i.onPointerPick()}),s.runRenderLoop(()=>{n.render()}),window.addEventListener("resize",()=>{s.resize()});const h=new BABYLON.TransformNode("inventory-parent",n);h.setParent(n.activeCamera),h.position=new vt(-.5,0,2);const w=BABYLON.MeshBuilder.CreatePlane("cursor",{},n);w.isPickable=!1,w.material=(t=>{const e="cursor";if(N[e])return N[e];const[s,n]=l(512);n.imageSmoothingEnabled=!1,n.lineCap="round",n.beginPath(),n.moveTo(250,256),n.lineTo(262,256),n.moveTo(256,250),n.lineTo(256,262),n.lineWidth=2,n.strokeStyle=r,n.stroke(),n.lineWidth=1.5,n.strokeStyle=o,n.stroke();const i=Y(s,t);return i.disableLighting=!0,i.emissiveColor=BABYLON.Color3.White(),i.diffuseTexture.hasAlpha=!0,N[e]=i,i})(n),w.setParent(i),w.position=new vt(0,0,1.1),w.renderingGroupId=1,new Tt("light",new vt(-.5,1,0),n);const d=new Tt("light",new vt(.5,-1,0),n),u=BABYLON.MeshBuilder.CreateSphere("skybox",{diameter:200,sideOrientation:BABYLON.Mesh.DOUBLESIDE},n),O=M({color1:a,color2:o,scale:.1});u.material=O,u.infiniteDistance=!0,d.includedOnlyMeshes.push(u);const A=gt.CreateTiledGround("ground",{xmin:-50,xmax:100,zmin:-20,zmax:80,subdivisions:{w:20,h:10}});A.material=(t=>{const e="grass";if(N[e])return N[e];const[s,n]=l(512),[i,o]=l(2*s.width),h=s.width/32;o.save();const r=["#abb348","#7ca244","#426d38","#799c45","#a7af48"],a=[];for(let t=0;32>t;t++)for(let e=0;32>e;e++)a.push({x:e,y:t});const c=(t=>{for(let e=t.length-1;e>1;e--){const s=Math.floor(Math.random()*e),n=t[e];t[e]=t[s],t[s]=n}return t})(a);o.translate(.25*i.width,.25*i.height),c.forEach(t=>{const{x:e,y:s}=t;o.save(),o.fillStyle=B(r),o.translate(e*h,s*h);const n=1*Math.random()+1,a=Math.random()*Math.PI;o.save(),o.scale(n,n),o.rotate(a),o.fillRect(-.5*h,-.5*h,h,h),o.restore(),0==e&&(o.save(),o.translate(.5*i.width,0),o.save(),o.scale(n,n),o.rotate(a),o.fillRect(-.5*h,-.5*h,h,h),o.restore(),o.restore()),0==s&&(o.save(),o.translate(0,.5*i.height),o.save(),o.scale(n,n),o.rotate(a),o.fillRect(-.5*h,-.5*h,h,h),o.restore(),o.restore()),o.restore()}),o.restore(),n.drawImage(i,.25*i.width,.25*i.height,.5*i.width,.5*i.height,0,0,s.width,s.height);const w=Y(s,t);return N[e]=w,w})(n),A.checkCollisions=!0,A.position.y=-.01;const L=new ft(n);L.position=new vt(-15,0,32);const p=new b(n);p.position=new vt(3,0,40),p.scale=new vt(2,2,2),i.setTarget(new vt(-1,10,43));const f=new X(n);f.position=new vt(15,0,18);const m=gt.CreateBox("bounds",{width:58,height:5,depth:32,sideOrientation:BABYLON.Mesh.BACKSIDE},n);m.position=new vt(4,0,28),m.checkCollisions=!0,m.visibility=0,s.hideLoadingUI();const g=await n.createDefaultXRExperienceAsync({floorMeshes:[...L.floors,...f.floors]});g.input.onControllerAddedObservable.add(t=>{t.onMotionControllerInitObservable.add(t=>{t.onModelLoadedObservable.add(t=>{h.setParent(t.rootMesh),h.position=new vt(0,.1,.1),h.rotation=vt.Zero()})})}),g.input.onControllerRemovedObservable.add(()=>{h.setParent(n.activeCamera),h.position=new vt(-.5,0,2),h.rotation=vt.Zero()}),g.baseExperience.onStateChangedObservable.add(e=>{t=e===BABYLON.WebXRState.IN_XR,w.isEnabled(!t),t||(h.setParent(n.activeCamera),h.position=new vt(-.5,0,2),h.rotation=vt.Zero())})};window.addEventListener("DOMContentLoaded",()=>{document.getElementById("playButton").onclick=St})</script><div id=intro style="text-align:center;font-family:Helvetica,sans-serif;max-width:420px;margin:0 auto"><h1>The Mystery at Glamis Castle</h1><h2>Created By Alex Swan</h2><h2>For JS13KGames 2023</h2><p>It is 1290 Scotland, and following the death of Queen Margaret there was no clear successor (the Great Cause). Witches placed a spell on Glamis Castle and whoever could solve the puzzles and enter will claim the kingdom.<p>Use a WebXR Pointer or WASD/Mouse to move and interact.</p><button id=playButton>PLAY</button></div><canvas id=c style=display:none></canvas><div id=extra></div>